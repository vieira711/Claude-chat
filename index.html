<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meu Claude Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tiempos+Text:ital,wght@0,400;0,500;1,400&family=Söhne:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    :root {
      --bg: #1a1714;
      --sidebar: #211e1b;
      --surface: #2a2622;
      --surface2: #322e29;
      --border: #3d3830;
      --border2: #4a443c;
      --text: #f0ebe3;
      --text2: #b8afa3;
      --text3: #7a7168;
      --accent: #cc785c;
      --accent2: #e8956d;
      --accent-glow: rgba(204,120,92,0.15);
      --user-bg: #2e2a26;
      --assistant-bg: transparent;
      --danger: #c0514a;
      --green: #5a9e6f;
      --amber: #c4863a;
      --radius: 12px;
      --font-body: 'Söhne', 'Helvetica Neue', sans-serif;
      --font-serif: 'Georgia', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      font-size: 15px;
      line-height: 1.6;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 260px;
      min-width: 260px;
      background: var(--sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .sidebar-top {
      padding: 16px 12px 12px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 8px 12px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--accent), #a85a40);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .new-chat-btn {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border2);
      color: var(--text);
      border-radius: var(--radius);
      padding: 9px 14px;
      font-size: 13.5px;
      font-family: var(--font-body);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s, border-color 0.15s;
      font-weight: 400;
    }

    .new-chat-btn:hover {
      background: var(--surface2);
      border-color: var(--border2);
    }

    .new-chat-btn svg { opacity: 0.6; flex-shrink: 0; }

    .conv-list-header {
      padding: 14px 16px 6px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text3);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .conv-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 8px;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .conv-list::-webkit-scrollbar { width: 4px; }
    .conv-list::-webkit-scrollbar-track { background: transparent; }
    .conv-list::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 99px; }

    .conv-item {
      border-radius: 9px;
      padding: 8px 10px;
      cursor: pointer;
      transition: background 0.12s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      group: true;
    }

    .conv-item:hover { background: var(--surface); }
    .conv-item.active { background: var(--surface2); }

    .conv-title {
      font-size: 13.5px;
      color: var(--text2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .conv-item.active .conv-title { color: var(--text); }

    .conv-del {
      opacity: 0;
      border: none;
      background: none;
      color: var(--text3);
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
      transition: opacity 0.12s, color 0.12s;
    }

    .conv-item:hover .conv-del { opacity: 1; }
    .conv-del:hover { color: var(--danger) !important; }

    .sidebar-footer {
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--green);
      flex-shrink: 0;
      transition: background 0.3s;
    }
    .status-dot.busy { background: var(--amber); }

    .status-text {
      font-size: 12px;
      color: var(--text3);
    }

    /* ===== MAIN ===== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      height: 100vh;
    }

    .topbar {
      padding: 13px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      background: var(--bg);
      gap: 12px;
      flex-shrink: 0;
    }

    .model-select {
      background: var(--surface);
      border: 1px solid var(--border2);
      color: var(--text2);
      padding: 6px 10px;
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 13px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.15s;
    }

    .model-select:hover { border-color: var(--accent); color: var(--text); }

    /* ===== CHAT ===== */
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    .chat::-webkit-scrollbar { width: 5px; }
    .chat::-webkit-scrollbar-track { background: transparent; }
    .chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

    .chat-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px;
      color: var(--text3);
    }

    .chat-empty-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent), #a85a40);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      margin-bottom: 4px;
      opacity: 0.85;
    }

    .chat-empty h2 {
      font-size: 18px;
      font-weight: 500;
      color: var(--text2);
      font-family: var(--font-serif);
    }

    .chat-empty p {
      font-size: 13.5px;
      text-align: center;
      max-width: 320px;
      line-height: 1.6;
    }

    .msg-group {
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
    }

    .msg-group:last-child { border-bottom: none; }

    .msg-inner {
      max-width: 720px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .msg-role {
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .role-avatar {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .role-avatar.user {
      background: var(--surface2);
      color: var(--text2);
    }

    .role-avatar.assistant {
      background: linear-gradient(135deg, var(--accent), #a85a40);
      color: white;
    }

    .msg-role.user { color: var(--text3); }
    .msg-role.assistant { color: var(--accent); }

    .bubble {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
    }

    .bubble p { margin-bottom: 12px; }
    .bubble p:last-child { margin-bottom: 0; }

    .bubble h1, .bubble h2, .bubble h3 {
      font-family: var(--font-serif);
      font-weight: 500;
      margin: 20px 0 8px;
      color: var(--text);
    }

    .bubble h1 { font-size: 20px; }
    .bubble h2 { font-size: 17px; }
    .bubble h3 { font-size: 15px; }

    .bubble ul, .bubble ol {
      padding-left: 20px;
      margin-bottom: 12px;
    }

    .bubble li { margin-bottom: 4px; }

    .bubble pre {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 10px;
      padding: 16px;
      overflow-x: auto;
      margin: 12px 0;
      font-size: 13.5px;
    }

    .bubble code {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 13px;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 5px;
      color: var(--accent2);
    }

    .bubble pre code {
      background: none;
      border: none;
      padding: 0;
      color: var(--text);
    }

    .bubble blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 14px;
      margin: 12px 0;
      color: var(--text2);
      font-style: italic;
    }

    .bubble a { color: var(--accent2); text-decoration: underline; }

    /* ===== COMPOSER ===== */
    .composer-wrap {
      padding: 16px 24px 20px;
      background: var(--bg);
      flex-shrink: 0;
    }

    .composer-inner {
      max-width: 720px;
      margin: 0 auto;
    }

    .att-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .att-chip {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 12.5px;
      color: var(--text2);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .att-chip button {
      border: none;
      background: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      transition: color 0.12s;
    }
    .att-chip button:hover { color: var(--danger); }

    .composer-box {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
      overflow: hidden;
    }

    .composer-box:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    textarea {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      padding: 14px 16px 10px;
      font-family: var(--font-body);
      font-size: 15px;
      color: var(--text);
      line-height: 1.6;
      min-height: 52px;
      max-height: 200px;
    }

    textarea::placeholder { color: var(--text3); }

    .composer-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px 10px;
      gap: 8px;
    }

    .composer-left { display: flex; gap: 6px; }

    .icon-btn {
      background: none;
      border: 1px solid transparent;
      border-radius: 8px;
      padding: 6px 8px;
      color: var(--text3);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-family: var(--font-body);
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .icon-btn:hover {
      background: var(--surface2);
      border-color: var(--border2);
      color: var(--text2);
    }

    .composer-right { display: flex; gap: 6px; align-items: center; }

    .send-btn {
      background: var(--accent);
      border: none;
      border-radius: 9px;
      padding: 7px 16px;
      color: white;
      font-family: var(--font-body);
      font-size: 13.5px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .send-btn:hover { background: var(--accent2); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .stop-btn {
      background: none;
      border: 1px solid var(--border2);
      border-radius: 9px;
      padding: 7px 14px;
      color: var(--text2);
      font-family: var(--font-body);
      font-size: 13.5px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stop-btn:hover { border-color: var(--danger); color: var(--danger); }
    .stop-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .hint-text {
      margin-top: 10px;
      font-size: 11.5px;
      color: var(--text3);
      text-align: center;
      line-height: 1.5;
    }

    .hint-text.error { color: #e07070; }

    /* Typing cursor */
    .typing-cursor::after {
      content: '▋';
      animation: blink 0.9s infinite;
      color: var(--accent);
      font-size: 13px;
    }
    @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:0} }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-top">
    <div class="logo">
      <div class="logo-icon">✦</div>
      Meu Claude Chat
    </div>
    <button class="new-chat-btn" id="newBtn">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M8 1v14M1 8h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
      Nova conversa
    </button>
  </div>

  <div class="conv-list-header">Conversas</div>
  <div class="conv-list" id="convList"></div>

  <div class="sidebar-footer">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-text" id="statusTxt">Pronto</span>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <select class="model-select" id="modelSel">
      <option value="claude-sonnet-4-5-20251001">Claude Sonnet 4.5</option>
      <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (econômico)</option>
    </select>
  </div>

  <div class="chat" id="chat">
    <div class="chat-empty" id="emptyState">
      <div class="chat-empty-icon">✦</div>
      <h2>Como posso ajudar?</h2>
      <p>Faça uma pergunta, envie um arquivo ou cole uma imagem com Ctrl+V.</p>
    </div>
  </div>

  <div class="composer-wrap">
    <div class="composer-inner">
      <div class="att-row" id="attRow" style="display:none"></div>
      <div class="composer-box">
        <textarea id="input" placeholder="Mensagem para Claude..." rows="1"></textarea>
        <div class="composer-actions">
          <div class="composer-left">
            <input id="fileInput" type="file" multiple
              accept="image/*,application/pdf,.txt,.py,.js,.json,.md,.csv,.env,.html"
              style="display:none">
            <button class="icon-btn" id="attachBtn">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Anexar
            </button>
          </div>
          <div class="composer-right">
            <button class="stop-btn" id="stopBtn" disabled>
              <svg width="12" height="12" viewBox="0 0 16 16"><rect x="3" y="3" width="10" height="10" rx="2" fill="currentColor"/></svg>
              Parar
            </button>
            <button class="send-btn" id="sendBtn">
              Enviar
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
        </div>
      </div>
      <div class="hint-text" id="hint">Dica: Ctrl+V para colar imagens · Shift+Enter para quebrar linha</div>
    </div>
  </div>
</main>

<script>
  const API = location.origin;

  const convList   = document.getElementById("convList");
  const chat       = document.getElementById("chat");
  const emptyState = document.getElementById("emptyState");
  const input      = document.getElementById("input");
  const sendBtn    = document.getElementById("sendBtn");
  const stopBtn    = document.getElementById("stopBtn");
  const newBtn     = document.getElementById("newBtn");
  const modelSel   = document.getElementById("modelSel");
  const hint       = document.getElementById("hint");
  const statusDot  = document.getElementById("statusDot");
  const statusTxt  = document.getElementById("statusTxt");
  const fileInput  = document.getElementById("fileInput");
  const attachBtn  = document.getElementById("attachBtn");
  const attRow     = document.getElementById("attRow");

  let currentId          = null;
  let streaming          = false;
  let controller         = null;
  let stickToBottom      = true;
  let pendingAttachments = [];

  marked.setOptions({ breaks: true });

  // Auto-resize textarea
  input.addEventListener("input", () => {
    input.style.height = "auto";
    input.style.height = Math.min(input.scrollHeight, 200) + "px";
  });

  function setStatus(busy, text) {
    statusDot.className = "status-dot" + (busy ? " busy" : "");
    statusTxt.textContent = text || (busy ? "Gerando..." : "Pronto");
  }

  function nearBottom() {
    return (chat.scrollHeight - (chat.scrollTop + chat.clientHeight)) < 140;
  }

  chat.addEventListener("scroll", () => { stickToBottom = nearBottom(); });

  function renderMarkdown(md) {
    return DOMPurify.sanitize(marked.parse(md || ""));
  }

  function showEmpty(show) {
    emptyState.style.display = show ? "flex" : "none";
  }

  function addMsg(role, text) {
    showEmpty(false);

    const group = document.createElement("div");
    group.className = "msg-group";

    const inner = document.createElement("div");
    inner.className = "msg-inner";

    const roleDiv = document.createElement("div");
    roleDiv.className = "msg-role " + role;

    const avatar = document.createElement("div");
    avatar.className = "role-avatar " + role;
    avatar.textContent = role === "user" ? "V" : "✦";

    const roleName = document.createElement("span");
    roleName.textContent = role === "user" ? "Você" : "Claude";

    roleDiv.appendChild(avatar);
    roleDiv.appendChild(roleName);

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = renderMarkdown(text || "");

    inner.appendChild(roleDiv);
    inner.appendChild(bubble);
    group.appendChild(inner);
    chat.appendChild(group);

    if (stickToBottom) chat.scrollTop = chat.scrollHeight;
    return bubble;
  }

  async function apiFetch(url, opts = {}) {
    const pass = localStorage.getItem("CHAT_PASSWORD") || "";
    opts.headers = opts.headers || {};
    if (pass) opts.headers["X-Auth"] = pass;
    return fetch(url, opts);
  }

  async function loadConversations() {
    const r = await apiFetch(API + "/api/conversations");
    if (r.status === 401) {
      const p = prompt("Digite a senha do chat:");
      if (p) localStorage.setItem("CHAT_PASSWORD", p);
      return loadConversations();
    }
    const data = await r.json();
    convList.innerHTML = "";
    data.conversations.forEach(c => {
      const item = document.createElement("div");
      item.className = "conv-item" + (c.id === currentId ? " active" : "");
      item.onclick = (e) => {
        if (!e.target.classList.contains("conv-del")) openConversation(c.id);
      };

      const title = document.createElement("div");
      title.className = "conv-title";
      title.textContent = c.title || "Nova conversa";

      const del = document.createElement("button");
      del.className = "conv-del";
      del.textContent = "✕";
      del.title = "Apagar conversa";
      del.onclick = async () => {
        await apiFetch(API + "/api/conversations/" + c.id, { method: "DELETE" });
        if (currentId === c.id) { currentId = null; chat.innerHTML = ""; showEmpty(true); }
        loadConversations();
      };

      item.appendChild(title);
      item.appendChild(del);
      convList.appendChild(item);
    });
  }

  async function openConversation(id) {
    currentId = id;
    await loadConversations();
    const r = await apiFetch(API + "/api/conversations/" + id);
    const c = await r.json();
    chat.innerHTML = "";
    const msgs = c.messages || [];
    if (msgs.length === 0) showEmpty(true);
    else {
      showEmpty(false);
      msgs.forEach(m => addMsg(m.role, m.content));
    }
    hint.textContent = "Dica: Ctrl+V para colar imagens · Shift+Enter para quebrar linha";
    hint.className = "hint-text";
    if (stickToBottom) chat.scrollTop = chat.scrollHeight;
  }

  async function newConversation() {
    const r    = await apiFetch(API + "/api/conversations", { method: "POST" });
    const data = await r.json();
    await openConversation(data.id);
  }

  // Ctrl+V para colar imagem
  document.addEventListener("paste", async (e) => {
    const items = Array.from(e.clipboardData?.items || []);
    for (const item of items) {
      if (item.type.startsWith("image/")) {
        const file = item.getAsFile();
        if (!file) continue;
        const att = await fileToAttachment(file);
        if (att) { pendingAttachments.push(att); renderAttachments(); }
      }
    }
  });

  attachBtn.onclick = () => fileInput.click();

  fileInput.addEventListener("change", async () => {
    for (const file of Array.from(fileInput.files || [])) {
      const att = await fileToAttachment(file);
      if (att) pendingAttachments.push(att);
    }
    fileInput.value = "";
    renderAttachments();
  });

  function renderAttachments() {
    if (!pendingAttachments.length) { attRow.style.display = "none"; return; }
    attRow.style.display = "flex";
    attRow.innerHTML = "";
    pendingAttachments.forEach((a, idx) => {
      const chip  = document.createElement("div");
      chip.className = "att-chip";
      const label = a.name || (a.kind === "pdf" ? "PDF" : a.kind === "image" ? "Imagem" : "Arquivo");
      chip.textContent = label + " ";
      const x = document.createElement("button");
      x.textContent = "✕";
      x.onclick = () => { pendingAttachments.splice(idx, 1); renderAttachments(); };
      chip.appendChild(x);
      attRow.appendChild(chip);
    });
  }

  async function fileToAttachment(file) {
    if (file.size > 5 * 1024 * 1024) {
      alert(`Arquivo muito grande (${(file.size/1024/1024).toFixed(1)}MB). Máximo: 5MB.`);
      return null;
    }
    const isImage = file.type.startsWith("image/");
    const isPdf   = file.type === "application/pdf";
    const isText  = file.type.startsWith("text/") ||
      [".py",".js",".json",".env",".md",".csv",".html",".txt"].some(ext => file.name.endsWith(ext));

    if (isImage) {
      const data = await readAsBase64(file);
      return { kind: "image", media_type: file.type || "image/png", data, name: file.name };
    }
    if (isPdf) {
      const data = await readAsBase64(file);
      return { kind: "pdf", media_type: "application/pdf", data, name: file.name };
    }
    if (isText) {
      const text = await file.text();
      return { kind: "text", text, name: file.name };
    }
    alert("Tipo de arquivo não suportado.");
    return null;
  }

  function readAsBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => {
        const s = String(r.result || "");
        const comma = s.indexOf(",");
        resolve(comma >= 0 ? s.slice(comma + 1) : s);
      };
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function send() {
    if (streaming) return;
    const text = input.value.trim();
    if (!text && pendingAttachments.length === 0) return;
    if (!currentId) await newConversation();

    input.value = "";
    input.style.height = "auto";

    const summary = pendingAttachments.length
      ? `**Anexos:** ${pendingAttachments.map(a => a.name).join(", ")}\n\n${text || ""}`
      : text;

    addMsg("user", summary || "_[Anexos enviados]_");
    const assistantBubble = addMsg("assistant", "");
    assistantBubble.classList.add("typing-cursor");

    streaming = true;
    sendBtn.disabled = true;
    stopBtn.disabled = false;
    hint.textContent = "";
    setStatus(true, "Gerando...");

    controller = new AbortController();

    const payload = {
      conversationId: currentId,
      message:        text,
      model:          modelSel.value,
      attachments:    pendingAttachments
    };

    pendingAttachments = [];
    renderAttachments();

    const r = await apiFetch(API + "/api/chat/stream", {
      method:  "POST",
      headers: { "Content-Type": "application/json" },
      body:    JSON.stringify(payload),
      signal:  controller.signal
    });

    if (!r.ok) {
      const err = await r.json().catch(() => ({}));
      assistantBubble.classList.remove("typing-cursor");
      assistantBubble.innerHTML = renderMarkdown("**Erro:** " + (err.error || "desconhecido"));
      hint.textContent = err.details ? String(err.details) : "";
      hint.className = "hint-text error";
      streaming = false;
      sendBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus(false, "Erro");
      await loadConversations();
      return;
    }

    const reader  = r.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buf     = "";
    let accText = "";

    try {
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buf += decoder.decode(value, { stream: true });
        const chunks = buf.split("\n\n");
        buf = chunks.pop() || "";

        for (const chunk of chunks) {
          const lines    = chunk.split("\n").map(l => l.trim()).filter(Boolean);
          let event      = "message";
          let dataLine   = null;

          for (const l of lines) {
            if (l.startsWith("event:")) event    = l.slice(6).trim();
            if (l.startsWith("data:"))  dataLine = l.slice(5).trim();
          }
          if (!dataLine) continue;

          const data = JSON.parse(dataLine);

          if (event === "token") {
            accText += data.t;
            assistantBubble.innerHTML = renderMarkdown(accText);
            if (stickToBottom) chat.scrollTop = chat.scrollHeight;
          }

          if (event === "error") {
            assistantBubble.classList.remove("typing-cursor");
            assistantBubble.innerHTML = renderMarkdown(accText + "\n\n**Erro:** " + (data.error || ""));
            hint.textContent = data.details || "";
            hint.className = "hint-text error";
          }
        }
      }
    } catch (e) { /* abort */ }

    assistantBubble.classList.remove("typing-cursor");
    streaming = false;
    sendBtn.disabled = false;
    stopBtn.disabled = true;
    controller = null;
    hint.textContent = "Dica: Ctrl+V para colar imagens · Shift+Enter para quebrar linha";
    hint.className = "hint-text";
    setStatus(false, "Pronto");
    await loadConversations();
  }

  function stop() {
    if (controller) controller.abort();
    stopBtn.disabled = true;
    streaming = false;
    sendBtn.disabled = false;
    setStatus(false, "Interrompido");
  }

  sendBtn.onclick = send;
  stopBtn.onclick = stop;
  newBtn.onclick  = newConversation;

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
  });

  (async () => {
    stickToBottom = true;
    await loadConversations();
    await newConversation();
  })();
</script>
</body>
</html>
